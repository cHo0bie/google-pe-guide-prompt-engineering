# Конспект по Prompt Engineering (RU)

> Шпаргалка и практикум на основе руководства Google по prompt engineering.  
> Фокус: **System/Role/Context → Task → Constraints → Format**, Few‑shot, **CoT/Step‑back**, **ReAct**, строгий JSON‑вывод, чек‑листы качества и шаблоны для банковского домена.

**Содержание**
- [1. Основа промпта](#1-основа-промпта)
- [2. Примеры и Few‑shot](#2-примеры-и-few-shot)
- [3. Структурированный вывод (JSON‑контракты)](#3-структурированный-вывод-json-контракты)
- [4. Техники рассуждений](#4-техники-рассуждений)
- [5. ReAct (Retrieve‑Act)](#5-react-retrieve-act)
- [6. Настройки вывода и стабильность](#6-настройки-вывода-и-стабильность)
- [7. Эксперименты и оценка качества](#7-эксперименты-и-оценка-качества)
- [8. Банковский домен: готовые шаблоны](#8-банковский-домен-готовые-шаблоны)
- [9. Быстрый старт с CLI](#9-быстрый-старт-с-cli)

---

## 1. Основа промпта

**Формула**
```
Prompt = [System] + [Role] + [Context] + [Task] + [Constraints] + [Format]
```
- **System** — политика и поведение модели.
- **Role** — «кем быть» модели (аналитик, ассистент и т. п.).
- **Context** — факты/ограничения/тон/источники.
- **Task** — точное задание.
- **Constraints** — запрещённые действия, длина, стиль.
- **Format** — *чёткий контракт вывода:* JSON/CSV/Markdown.

**Приёмы**
- Явные разделители: `---`, «Вход:», «Выход:».
- Запрещающие формулировки: «Если данных нет — верни `N/A`».
- Нумерация подпунктов, чтобы снизить пропуски в ответе.

---

## 2. Примеры и Few‑shot

- **Zero‑shot** — без примеров: быстро тестировать идею.
- **One‑/Few‑shot** — добавить 1–5 коротких **эталонов**.
- **Контрастный пример** (антипаттерн) помогает задать «красные линии».

**Шаблон** → `prompts/patterns/01_few_shot.md`

---

## 3. Структурированный вывод (JSON‑контракты)

Почему это важно: воспроизводимость, интеграция в пайплайн и проверяемость.

**Политика ошибок**
- Если невозможно заполнить схему — верни `{"answer":"N/A"}`.
- Никаких пояснений вне JSON.

**JSON Schema / Pydantic**
- Схемы в `banking/schemas/*.json` (пример: реквизиты, жалобы).
- Валидация: CLI и Streamlit поддерживают проверку через `jsonschema`.

**Repair‑шаг (опционально)**
- Если JSON «битый»: прогнать через «починку» и повторную валидацию.

Шаблоны:
- `prompts/patterns/04_json_contract.md`
- Банковские: `prompts/banking/extract_requisites.md`, `complaint_triage.md`

---

## 4. Техники рассуждений

### 4.1 Chain‑of‑Thought (CoT)
Попросите «подумать шагами», но **вернуть только финал**. В веб‑UI это управление происходит чекбоксом/шаблоном.
- Важно: скрывайте CoT в проде, если не нужен «объяснительный» ответ.

### 4.2 Step‑back
Сначала сформулировать **общие принципы/допущения**, затем решить задачу уже с опорой на них. Полезно для задач с контекстом и правилами.

### 4.3 Self‑consistency (мульти‑выбор)
Сгенерировать несколько черновиков и выбрать лучший/единый ответ (энтропийный сэмплинг + ранжирование).

Шаблоны см. в `prompts/patterns/02_cot.md`, `03_step_back.md`.

---

## 5. ReAct (Retrieve‑Act)
Смешиваем явные **действия** (взять данные / проверить правило) и генерацию. Просим объяснять, **какое действие** выполнено и какой контекст получен. Подходит для RAG/инструментов.

Шаблон → `prompts/patterns/05_react.md`

---

## 6. Настройки вывода и стабильность

- **Температура**: 0.0–0.3 для детерминизма, выше — для креатива.
- **Длина**: выделяйте бюджет токенов (например, `≤ 700`).
- **Формат**: жёстко закрепляйте: «верни ТОЛЬКО JSON».
- **Снижение галлюцинаций**: цитирование источников, Step‑back/CoT, отрицательные примеры.

---

## 7. Эксперименты и оценка качества

**Как вести эксперименты**
- Версионируйте промпты, храните переменные и результаты (в проекте есть вкладка «История» и экспорт JSON).
- A/B: меняйте ОДНУ деталь за раз.

**RAG‑чек‑лист (relevancy/faithfulness)**
- Файл: `banking/checklists/rag_relevancy_checklist.md` (оценка по 0–2).  
  Порог приёмки: сумма ≥ 7 и **F2 (faithfulness) = 2**.

**Негативные тест‑кейсы**
- Файл: `banking/negative_tests/faq_negatives.md`  
  (privacy, security, out_of_scope, prompt‑injection, not_in_corpus…).

---

## 8. Банковский домен: готовые шаблоны

- **Ответ с цитатами**: `prompts/banking/faq_with_citations.md`  
  Контракт: `{"answer": "...", "citations": ["id1","id2"]}`.
- **Жалобы (триаж)**: `prompts/banking/complaint_triage.md` → схема `banking/schemas/complaint_schema.json`
- **Реквизиты**: `prompts/banking/extract_requisites.md` → схема `banking/schemas/requisites_schema.json`
- **Схема перевыпуска карты**: `banking/schemas/card_reissue_schema.json`

---

## 9. Быстрый старт с CLI

```bash
# 1) Извлечь реквизиты и провалидировать JSON
python scripts/run.py chat \
  --prompt-file prompts/banking/extract_requisites.md \
  --var text="Счёт 40817810..., получатель ООО Ромашка" \
  --schema banking/schemas/requisites_schema.json

# 2) Классифицировать жалобу
python scripts/run.py chat \
  --prompt-file prompts/banking/complaint_triage.md \
  --var complaint="Списали комиссию дважды" \
  --schema banking/schemas/complaint_schema.json

# 3) Ответ с цитатами (RAG)
python scripts/run.py chat \
  --prompt-file prompts/banking/faq_with_citations.md \
  --var question="Как перевыпустить карту?" \
  --var passages="[1] Перевыпуск...\\n[2] Сроки..."
```

> Для удобного чтения в GitHub открывайте **notebooks.md** (а не `notebooks.mk`). Содержимое идентично, но оформлено как полноценная статья.


---

## Политики безопасности (дополнение к проектам)

**Строго JSON‑вывод.** Для задач со структурированным ответом запрещён любой текст вне JSON: никаких преамбул, `markdown`‑блоков, комментариев или «```json». Только чистый JSON. При невозможности — вернуть объект `{"error": {"message": "...", "reason": "cannot_answer"}}`.

**Маскирование платёжных реквизитов.** Для номеров карт/счетов/договоров показывать первые 4 и последние 4 цифры, остальные заменять на `*`: `1234********5678`. Правило действует и для логов/цитат.

**Секреты клиента.** PIN, CVV/CVC, одноразовые коды и пароли не сохранять и не повторять. Если клиент прислал такие данные — предупредить и предложить безопасный канал (менеджер/официальная поддержка).

**Фишинговые/подозрительные запросы.** Признаки: сбор платёжных/личных данных, неизвестные ссылки/вложения, «срочно подтвердить/перевести». Действия: (1) предупредить и вежливо отказать; (2) не переходить по ссылкам; (3) предложить официальный канал; (4) эскалировать.

Эти правила внедрены в шаблоны промптов и в код (маскирование перед логированием).
